<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Daily Alerts — Timeline View (V6a)</title>
<base target="_blank">
<style>
  body{margin:0;font:14px system-ui;background:#f7fafc;color:#0f172a}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:0 0 10px;font-size:24px}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin:12px 0}
  .btn{padding:6px 12px;border-radius:8px;border:1px solid #e2e8f0;cursor:pointer;background:#fff}
  details.day{border:1px solid #e2e8f0;border-radius:14px;background:#fff;margin:10px 0}
  details>summary{list-style:none;cursor:pointer;padding:12px 16px;display:flex;gap:10px;align-items:center;border-bottom:1px solid #e2e8f0}
  details>summary::-webkit-details-marker{display:none}
  .alert{border-bottom:1px dashed #e2e8f0;padding:12px 16px}
  .alert:last-child{border-bottom:none}
  .alert-title{font-weight:600}
  .badge{border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:4px}
  .item-card{border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px;margin:6px 0;background:#fff}
  dialog{border:none;border-radius:16px;padding:0}
</style>
</head>
<body>
<div class="container">
  <h1>Daily Alerts — Timeline (V6a)</h1>
  <div style="margin-bottom:12px">
    <input id="syncUrl" style="width:60%" value="https://gist.githubusercontent.com/nikhil2kamat/fa0d49eff48903c320f0ee911de3ba4d/raw/alerts.json">
    <button class="btn" id="btnSync">Sync now</button>
    <label><input type="checkbox" id="autoSync" checked> Auto-sync</label>
    <select id="syncInterval"><option value="5">5m</option><option value="15" selected>15m</option><option value="30">30m</option><option value="60">60m</option></select>
    <span id="syncMsg" style="margin-left:10px;font-size:12px;color:#64748b">Last sync: never</span>
  </div>
  <section id="timeline"></section>
</div>

<dialog id="dlgDetails"><div class="card"><h3 id="d_title"></h3><div id="d_sections"></div><button class="btn" onclick="this.closest('dialog').close()">Close</button></div></dialog>

<script>
(function(){
  const els={syncUrl:document.getElementById('syncUrl'),autoSync:document.getElementById('autoSync'),syncInterval:document.getElementById('syncInterval'),btnSync:document.getElementById('btnSync'),syncMsg:document.getElementById('syncMsg'),timeline:document.getElementById('timeline'),dlgDetails:document.getElementById('dlgDetails'),d_title:document.getElementById('d_title'),d_sections:document.getElementById('d_sections')};
  let alerts=[];

  async function fetchSync(){
    const url=(els.syncUrl.value||'').trim(); if(!url) return;
    try{
      els.syncMsg.textContent='Syncing…';
      const res=await fetch(url+'?'+Date.now(),{method:'GET',cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data=await res.json();
      const list=Array.isArray(data)?data:data.alerts;
      if(!Array.isArray(list)) throw new Error('JSON must be array or {alerts:[…]}');
      alerts=list;
      render();
      els.syncMsg.textContent='Last sync '+new Date().toLocaleTimeString();
    }catch(e){ els.syncMsg.textContent='Sync failed: '+(e.message||e); }
  }

  function render(){
    els.timeline.innerHTML='';
    if(!alerts.length){els.timeline.textContent='No alerts.';return;}
    const groups={};
    alerts.forEach(a=>{const day=a.time?a.time.slice(0,10):'unknown';(groups[day]=groups[day]||[]).push(a);});
    Object.keys(groups).sort().reverse().forEach(day=>{
      const det=document.createElement('details');det.className='day';det.id='day-'+day;det.open=(day===new Date().toISOString().slice(0,10));
      const sum=document.createElement('summary');sum.textContent=day+' ('+groups[day].length+' alerts)';det.appendChild(sum);
      groups[day].sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(a=>{
        const row=document.createElement('div');row.className='alert';
        const t=document.createElement('div');t.className='alert-title';t.textContent=a.title;row.appendChild(t);
        const meta=document.createElement('div');meta.style.fontSize='12px';meta.style.color='#64748b';meta.textContent=`${a.time} • ${a.category} • ${a.source||''}`;row.appendChild(meta);
        const btn=document.createElement('button');btn.className='btn';btn.textContent='View';btn.onclick=()=>openDetails(a);row.appendChild(btn);
        det.appendChild(row);
      });
      els.timeline.appendChild(det);
    });
  }

  function openDetails(a){
    els.d_title.textContent=a.title;
    els.d_sections.innerHTML='';
    (a.sections||[]).forEach(s=>{
      const wrap=document.createElement('div');wrap.style.margin='8px 0';
      const h=document.createElement('div');h.style.fontWeight='600';h.textContent=s.heading;wrap.appendChild(h);
      (s.items||[]).forEach(it=>{
        const card=document.createElement('div');card.className='item-card';
        const ti=document.createElement('div');ti.textContent=it.title;ti.style.fontWeight='600';card.appendChild(ti);
        if(it.summary){const sm=document.createElement('div');sm.textContent=it.summary;card.appendChild(sm);}
        if(it.link){const aTag=document.createElement('a');aTag.href=it.link;aTag.textContent='Source';aTag.className='btn';card.appendChild(aTag);}
        wrap.appendChild(card);
      });
      els.d_sections.appendChild(wrap);
    });
    els.dlgDetails.showModal();
  }

  els.btnSync.onclick=fetchSync;
  if(els.autoSync.checked){ setInterval(fetchSync,Number(els.syncInterval.value)*60000); }
  fetchSync();
})();
</script>
</body>
</html>
